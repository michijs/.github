name: Michijs dependabot
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  list-repositories:
    runs-on: ubuntu-latest
    outputs:
      repositories: ${{ steps.list-repositories.outputs.repositories }}
      name: ${{ steps.setup-credentials.outputs.name}}
      email: ${{ steps.setup-credentials.outputs.email}}
    steps:
      - name: List org repositories
        id: list-repositories
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          result-encoding: string
          script: |
            const { data } = await github.rest.repos.listForOrg({ org: "michijs" });
            const repositories = data.filter(x => !x.disabled && !x.archived).map(r => ({
              name: r.name,
              full_name: r.full_name,
              default_branch: r.default_branch
            }));
            core.setOutput('repositories', JSON.stringify(repositories));
      - name: Setup credentials
        id: setup-credentials
        uses: michijs/.github/.github/actions/setup-credentials@main
        with:
          michijs_bot_app_id: ${{ vars.MICHIJS_BOT_APP_ID }}
          michijs_bot_private_key: ${{ secrets.MICHIJS_BOT_PRIVATE_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip-token-revoke: true
      - name: Saves token in a temp variable
        run: echo "TEMP_GITHUB_TOKEN=${{env.GITHUB_TOKEN}}" >> "$GITHUB_ENV"
      - name: Set TEMP_GITHUB_TOKEN on secrets
        run: gh secret set --org michijs TEMP_GITHUB_TOKEN --visibility all --body ${{ env.TEMP_GITHUB_TOKEN }}
        env: 
          GITHUB_TOKEN: ${{ secrets.PAT }}
        
  run-dependabot:
    runs-on: ubuntu-latest
    needs: list-repositories
    strategy:
      matrix:
        repository: ${{ fromJson(needs.list-repositories.outputs.repositories) }}
    steps:
      - name: Set credentials
        uses: michijs/.github/.github/actions/set-credentials@main
        with:
          github_token: ${{ secrets.TEMP_GITHUB_TOKEN }}
          email: ${{ needs.list-repositories.outputs.email }}
          name: ${{ needs.list-repositories.outputs.name }}
      - name: "Run dependabot on ${{matrix.repository.name}}"
        uses: michijs/.github/.github/actions/dependabot@main
        continue-on-error: true
        with:
          repository: ${{ matrix.repository.full_name }}
          ref: ${{ matrix.repository.default_branch }}
            
